-- 서브쿼리

-- Abel 직원보다 급여를 더 많이 받는 직원 들은?
-- Abel의 급여 확인
SELECT salary
FROM employees 
WHERE last_name = 'Abel';

--서브쿼리를 사용
-- 단일행 연산자 (=,>,<,<=,=>,)
 SELECT employee_id,last_name,salary
 FROM employees
 WHERE salary > (SELECT salary
                 FROM employees 
                 WHERE last_name = 'Abel');
-- 에러가 나는 경우
 SELECT employee_id,last_name,salary
 FROM employees
 WHERE salary > (SELECT salary
                 FROM employees 
                 WHERE department_id = 30);

--집계함수를 서브쿼리로 사용
--집계함수 예로 MAX는 가장높은 급여를 받는 사람을 알수없음
SELECT *
FROM employees
WHERE salary = (SELECT MAX(salary) FROM employees);


--여러개의 서브쿼리
SELECT last_name 이름 , job_id 직종, salary 급여
FROM employees
where job_id = (SELECT job_id
                FROM employees
                WHERE last_name ='Chen')
   AND salary >(SELECT salary
                FROM employees
                WHERE last_name ='Chen');
                
-- 예제 1)'Bull'이란 last_name을 가진 사원의 부서에서 bull 보다 높은급여를 받는 사원들을 출력하라
SELECT employee_id 직원번호, last_name 이름,
department_id 부서번호, salary 급여
FROM employees
WHERE department_id = (SELECT department_id
                       FROM employees
                       WHERE last_name ='Bull')
    AND salary > (     SELECT salary
                       FROM employees
                       WHERE last_name ='Bull');
                       
-- 예제 2) 'Russell'이란 last_name의 직원번호를 manager_id로 가지는직원들의
-- last_name,salary,manager_id를 출력하시오
SELECT last_name,salary,manager_id
FROM employees
WHERE manager_id = (  SELECT employee_id
                       FROM employees
                       WHERE last_name ='Russell');
                       
-- 예제 3) jobs 테이블에 job_title이 'Stock Manager'의 job_id를 가진 직원들의 정보를
--employees 테이블에서 찾아서 출력하시오
SELECT *
FROM employees
WHERE job_id = (    SELECT job_id
                    FROM jobs
                    WHERE job_title ='Stock Manager');
                    
--다중행 서브쿼리

--연산자 (in,any,all)
SELECT salary
FROM employees
WHERE department_id = 90;

-- IN
SELECT employee_id,first_name,last_name,salary
FROM employees
WHERE salary IN (SELECT salary
                 FROM employees
                 WHERE department_id = 90);

-- Any : 하나의 조건만 만족해도 됨
SELECT employee_id, first_name, last_name, salary
FROM employees
WHERE salary >= ANY (SELECT salary
                     FROM employees
                     WHERE department_id = 90);

-- ALL : 모든 조건을 만족해야함
SELECT employee_id, first_name, last_name, salary
FROM employees
WHERE salary >= ALL (SELECT salary
                     FROM employees
                     WHERE department_id = 90);
                     
-- 예제 1)
SELECT employee_id, last_name, job_id, salary
FROM employees
where salary < Any (SELECT salary
                    FROM employees
                    WHERE job_id = 'ST_MAN');
                    
-- 예제 2)
SELECT employee_id, last_name, job_id, salary
FROM employees
where salary < ALL (SELECT salary
                    FROM employees
                    WHERE job_id = 'IT_PROG');
                    

-- 다중열 서브쿼리
SELECT employee_id, first_name, job_id, salary, manager_id
FROM employees
WHERE (manager_id, job_id) IN (SELECT manager_id,job_id
                               FROM employees
                               WHERE first_name = 'Bruce')
                               AND first_name != 'Bruce';

-- 부서별로 최소 급여를 받는 사원의 부서번호,사원번호,이름 급여 정보검색
SELECT department_id 부서번호, employee_id 사원번호,
       first_name 이름, salary 급여
FROM employees
WHERE (department_id, salary)IN(SELECT department_id, MIN(salary)
                                FROM employees
                                GROUP BY department_id )
                                ORDER BY department_id;
                                
-- 예제 1)
SELECT first_name,job_id,salary,department_id 
FROM employees
WHERE (job_id,salary) IN(SELECT job_id, MIN(salary)
                         FROM employees
                         GROUP BY job_id)
                         ORDER BY salary DESC;